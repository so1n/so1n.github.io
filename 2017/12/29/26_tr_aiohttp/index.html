

<!DOCTYPE html>
<html lang="zh-Hans" color-mode=light>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>aiohttp文档翻译 - So1n blog</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="google" content="notranslate" />
  
  <meta name="description" content="前记状态弃坑中，官方文档更新了结构要重新编排**完美弃...">
  <meta name="author" content="So1n">
  <link rel="icon" href="/images/icons/favicon.ico" type="image/png" sizes="16x16">
  <link rel="icon" href="/images/icons/favicon.ico" type="image/png" sizes="32x32">
  <link rel="apple-touch-icon" href="/images/icons/favicon.ico" sizes="180x180">
  <meta rel="mask-icon" href="/images/icons/stun-logo.svg" color="#333333">
  
    <meta rel="msapplication-TileImage" content="/images/icons/favicon.ico">
    <meta rel="msapplication-TileColor" content="#000000">
  

  
<link rel="stylesheet" href="/css/style.css">


  
    
<link rel="stylesheet" href="//at.alicdn.com/t/font_1445822_s6x2xcokxrl.css">

  

  
    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css">

  

  
    
      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/atom-one-dark.min.css" name="highlight-style" mode="light">

      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/atom-one-dark.min.css" name="highlight-style" mode="dark">

      
  

  <script>
    var CONFIG = window.CONFIG || {};
    var ZHAOO = window.ZHAOO || {};
    CONFIG = {
      isHome: false,
      fancybox: true,
      pjax: false,
      lazyload: {
        enable: true,
        only_post: 'false',
        loading: '/images/theme/loading.gif'
      },
      donate: {
        enable: true,
        alipay: 'https://pic.izhaoo.com/alipay.jpg',
        wechat: 'https://pic.izhaoo.com/wechat.jpg'
      },
      galleries: {
        enable: true
      },
      fab: {
        enable: true,
        always_show: true
      },
      carrier: {
        enable: false
      },
      daovoice: {
        enable: false
      },
      preview: {
        background: {
          default: '/images/theme/welcome-image.jpg',
          api: 'https://source.unsplash.com/random/1920x1080'
        },
        motto: {
          default: '我们总说社会是个大染缸 其实是我们自己掉色',
          api: '',
          data_contents: '["data","content"]'
        },
      },
      qrcode: {
        enable: true,
        type: 'url',
        image: 'https://pic.izhaoo.com/weapp-code.jpg',
      },
      toc: {
        enable: true
      },
      scrollbar: {
        type: 'simple'
      },
      notification: {
        enable: false,
        delay: 4500,
        list: '',
        page_white_list: '',
        page_black_list: ''
      }
    }
  </script>

  

  

<meta name="generator" content="Hexo 5.3.0"></head>

<body class="lock-screen">
  <div class="loading"></div>
  


  <nav class="navbar">
    <div class="left">
      
        <i class="iconfont iconqrcode j-navbar-qrcode"></i>
      
      
        <i class="iconfont iconmoono" id="color-toggle" color-toggle="light"></i>
      
    </div>
    <div class="center">aiohttp文档翻译</div>
    <div class="right">
      <i class="iconfont iconmenu j-navbar-menu"></i>
    </div>
    
      <div id="qrcode-navbar"></div>
    
  </nav>

  

<nav class="menu">
  <div class="menu-wrap">
    <div class="menu-close">
      <i class="iconfont iconbaseline-close-px"></i>
    </div>
    <ul class="menu-content"><li class="menu-item">
        <a href="/ " class="underline "> 首页</a>
      </li><li class="menu-item">
        <a href="/galleries/ " class="underline "> 摄影</a>
      </li><li class="menu-item">
        <a target="_blank" rel="noopener" href="http://so1nz.lofter.com/ " class="underline "> 时光</a>
      </li><li class="menu-item">
        <a href="/archives/ " class="underline "> 归档</a>
      </li><li class="menu-item">
        <a href="/tags/ " class="underline "> 标签</a>
      </li><li class="menu-item">
        <a href="/categories/ " class="underline "> 分类</a>
      </li><li class="menu-item">
        <a href="/about/ " class="underline "> 关于</a>
      </li></ul>
    
      <div class="menu-copyright"><p>Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme - <a target="_blank" href="https://github.com/izhaoo/hexo-theme-zhaoo">zhaoo</a></p></div>
    
  </div>
</nav>
  <main id="main">
  <div class="article-wrap">
    <div class="row container">
      <div class="col-xl-3"></div>
      <div class="col-xl-6"><article class="article">
  <div class="wrap">
    <section class="head">
  <img   class="lazyload" data-original="/images/theme/post-image.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  draggable="false">
  <div class="head-mask">
    <h1 class="head-title">aiohttp文档翻译</h1>
    <div class="head-info">
      <span class="post-info-item"><i class="iconfont iconcalendar"></i>December 29, 2017</span>
      
      本文总阅读量<span id="busuanzi_value_page_pv"></span>次
      <span class="post-info-item"><i class="iconfont iconfont-size"></i>16163</span>
    </div>
  </div>
</section>

    <section class="main">
      <section class="content">
        <p>ps：语法使用python3.5的语法，也就是从</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-meta">@asyncio.coroutine</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">coro</span>(<span class="hljs-params">...</span>):</span><br>    ret = <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> f()<br></code></pre></td></tr></table></figure>
<p>改为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">coro</span>(<span class="hljs-params">...</span>):</span><br>    ret = <span class="hljs-keyword">await</span> f()<br></code></pre></td></tr></table></figure>
<p>之前为了学习英语+想查文档然后就简单的翻译下<br><a target="_blank" rel="noopener" href="http://aiohttp.readthedocs.io/en/stable/toc.html#mastertoc">原网址</a></p>
<h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><p>aiohttp当做请求时:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> aiohttp<br><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> async_timeout<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fetch</span>(<span class="hljs-params">session, url</span>):</span><br>    <span class="hljs-keyword">with</span> async_timeout.timeout(<span class="hljs-number">10</span>):<br>        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(url) <span class="hljs-keyword">as</span> response:<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> response.text()<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<br>        html = <span class="hljs-keyword">await</span> fetch(session, <span class="hljs-string">&#x27;http://python.org&#x27;</span>)<br>        print(html)<br><br>loop = asyncio.get_event_loop()<br>loop.run_until_complete(main())<br></code></pre></td></tr></table></figure>
<p>当做服务器时</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle</span>(<span class="hljs-params">request</span>):</span><br>    name = request.match_info.get(<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&quot;Anonymous&quot;</span>)<br>    text = <span class="hljs-string">&quot;Hello, &quot;</span> + name<br>    <span class="hljs-keyword">return</span> web.Response(text=text)<br><br>app = web.Application()<br>app.router.add_get(<span class="hljs-string">&#x27;/&#x27;</span>, handle)<br>app.router.add_get(<span class="hljs-string">&#x27;/&#123;name&#125;&#x27;</span>, handle)<br><br>web.run_app(app)<br></code></pre></td></tr></table></figure>
<h2 id="使用aiohttp进行请求"><a href="#使用aiohttp进行请求" class="headerlink" title="使用aiohttp进行请求"></a>使用aiohttp进行请求</h2><h3 id="提出请求"><a href="#提出请求" class="headerlink" title="提出请求"></a>提出请求</h3><p>先对 url:<a target="_blank" rel="noopener" href="https://api.github.com/events">https://api.github.com/events</a> 进行请求，然后返回文本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> aiohttp<br><span class="hljs-keyword">import</span> asyncio<br><br><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<br>        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&#x27;https://api.github.com/events&#x27;</span>) <span class="hljs-keyword">as</span> resp:<br>            print(resp.status)<br>            print(<span class="hljs-keyword">await</span> resp.text())<br><br>loop = asyncio.get_event_loop()<br>loop.run_until_complete(main())<br></code></pre></td></tr></table></figure>
<p>可以看出根requests的语法很像，代码中有一个ClientSession被调用session的ClientResponse对象resp。我们可以从响应中获得所需的所有信息，除了get外，也支持其他http协议</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Python">session.post(<span class="hljs-string">&#x27;http://httpbin.org/post&#x27;</span>, data=<span class="hljs-string">b&#x27;data&#x27;</span>)<br>session.put(<span class="hljs-string">&#x27;http://httpbin.org/put&#x27;</span>, data=<span class="hljs-string">b&#x27;data&#x27;</span>)<br>session.delete(<span class="hljs-string">&#x27;http://httpbin.org/delete&#x27;</span>)<br>session.head(<span class="hljs-string">&#x27;http://httpbin.org/get&#x27;</span>)<br>session.options(<span class="hljs-string">&#x27;http://httpbin.org/get&#x27;</span>)<br>session.patch(<span class="hljs-string">&#x27;http://httpbin.org/patch&#x27;</span>, data=<span class="hljs-string">b&#x27;data&#x27;</span>)<br></code></pre></td></tr></table></figure>
<blockquote>
<p>需要注意的是，不必要为每个请求创建一个session，当有多个请求时，把url传入session就可以了，session中包含一个连接池，默认情况下打开连接重用和保持活动</p>
</blockquote>
<h3 id="JSON请求"><a href="#JSON请求" class="headerlink" title="JSON请求"></a>JSON请求</h3><p>通过以下设置，可以让aiohttp发起一个json请求</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.post(json=&#123;<span class="hljs-string">&#x27;test&#x27;</span>: <span class="hljs-string">&#x27;object&#x27;</span>&#125;)<br></code></pre></td></tr></table></figure>
<p>默认情况下使用python自带的json序列,如果需要更改可以更改ClientSession里的json_serialize参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> ujson<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession(json_serialize=ujson.dumps) <span class="hljs-keyword">as</span> session:<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.post(json=&#123;<span class="hljs-string">&#x27;test&#x27;</span>: <span class="hljs-string">&#x27;object&#x27;</span>&#125;)<br></code></pre></td></tr></table></figure>
<h3 id="在url中传递参数"><a href="#在url中传递参数" class="headerlink" title="在url中传递参数"></a>在url中传递参数</h3><p>如果有多次相同请求，只是网址中的键/值不一样时，如httpbin.org/get?key=val，那可以使用params关键字参数，把封装好的dict给aiohttp调用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">params = &#123;<span class="hljs-string">&#x27;key1&#x27;</span>: <span class="hljs-string">&#x27;value1&#x27;</span>, <span class="hljs-string">&#x27;key2&#x27;</span>: <span class="hljs-string">&#x27;value2&#x27;</span>&#125;<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&#x27;http://httpbin.org/get&#x27;</span>,<br>                       params=params) <span class="hljs-keyword">as</span> resp:<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">str</span>(resp.url) == <span class="hljs-string">&#x27;http://httpbin.org/get?key2=value2&amp;key1=value1&#x27;</span><br></code></pre></td></tr></table></figure>
<p>如果是需要一对多形式的键/值可以采用如下形式，为每个键指定多个值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Python">params = [(<span class="hljs-string">&#x27;key&#x27;</span>, <span class="hljs-string">&#x27;value1&#x27;</span>), (<span class="hljs-string">&#x27;key&#x27;</span>, <span class="hljs-string">&#x27;value2&#x27;</span>)]<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&#x27;http://httpbin.org/get&#x27;</span>,<br>                       params=params) <span class="hljs-keyword">as</span> r:<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">str</span>(r.url) == <span class="hljs-string">&#x27;http://httpbin.org/get?key=value2&amp;key=value1&#x27;</span><br></code></pre></td></tr></table></figure>
<p>也可以使用str来当做参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&#x27;http://httpbin.org/get&#x27;</span>,<br>                       params=<span class="hljs-string">&#x27;key=value+1&#x27;</span>) <span class="hljs-keyword">as</span> r:<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">str</span>(r.url) == <span class="hljs-string">&#x27;http://httpbin.org/get?key=value+1&#x27;</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>aiohttp在发送请求之前在内部执行URL 标准化<br>例如URL(‘<a target="_blank" rel="noopener" href="http://example.com/%D0%BF%D1%83%D1%82%D1%8C%30?a=1&#39;)%E8%A2%AB%E8%BD%AC%E6%8D%A2%E4%B8%BA">http://example.com/путь%30?a=%31&#39;)被转换为</a> URL(‘<a target="_blank" rel="noopener" href="http://example.com/%D0%BF%D1%83%D1%82%D1%8C/0?a=1&#39;)%E3%80%82">http://example.com/%D0%BF%D1%83%D1%82%D1%8C/0?a=1&#39;)。</a><br>如果服务器不接受时，可以通过设置encoded来改变</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">await</span> session.get(URL(<span class="hljs-string">&#x27;http://example.com/%30&#x27;</span>, encoded=<span class="hljs-literal">True</span>))<br></code></pre></td></tr></table></figure>
<h3 id="解析的内容"><a href="#解析的内容" class="headerlink" title="解析的内容"></a>解析的内容</h3><ul>
<li><p>使用text()<br>在aiohttp中会根据网站定义的编码来自动解析网页中的内容，当然，也可以通过设置encoding变量来定义我们要解析的编码格式，如果习惯使用resquests的，要注意这里是text()，待括号的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">await</span> resp.text(encoding=<span class="hljs-string">&#x27;windows-1251&#x27;</span>)<br></code></pre></td></tr></table></figure></li>
<li><p>使用read()<br>则解析出来的是二进制的内容，且网页内容过多时，无法全部解析</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">await</span> resp.read()<br></code></pre></td></tr></table></figure></li>
<li><p>使用json()<br>解析后自动转化为json格式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&#x27;https://api.github.com/events&#x27;</span>) <span class="hljs-keyword">as</span> resp:<br>    print(<span class="hljs-keyword">await</span> resp.json())<br></code></pre></td></tr></table></figure></li>
<li><p>流响应内容<br>就是像我们在用python打开文件时，如果文件过大，都不会一下子去打开的，可能是一行一行打开，也可能是一段一段打开，总之就是为了避免内存爆满，后面的东西无法写入。<br>可以使用这样写入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&#x27;https://api.github.com/events&#x27;</span>) <span class="hljs-keyword">as</span> resp:<br>    <span class="hljs-keyword">await</span> resp.content.read(<span class="hljs-number">10</span>)<br></code></pre></td></tr></table></figure>
<p>但是最好的方式应该为:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filename, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> fd:<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        chunk = <span class="hljs-keyword">await</span> resp.content.read(chunk_size)<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> chunk:<br>            <span class="hljs-keyword">break</span><br>        fd.write(chunk)<br></code></pre></td></tr></table></figure>
<h3 id="请求的信息-Headers，Cookies"><a href="#请求的信息-Headers，Cookies" class="headerlink" title="请求的信息(Headers，Cookies)"></a>请求的信息(Headers，Cookies)</h3><p>aiohttp中单的ClientResposeClientResponse对象包含request_info属性，其中包含Headers和cookies，可以通过一定的设置来向服务器发送不同的东西。</p>
</li>
<li><p>定义Headers</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">import</span> json<br>url = <span class="hljs-string">&#x27;https://api.github.com/some/endpoint&#x27;</span><br>payload = &#123;<span class="hljs-string">&#x27;some&#x27;</span>: <span class="hljs-string">&#x27;data&#x27;</span>&#125;<br>headers = &#123;<span class="hljs-string">&#x27;content-type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>&#125;<br><br><span class="hljs-keyword">await</span> session.post(url,<br>                   data=json.dumps(payload),<br>                   headers=headers)<br></code></pre></td></tr></table></figure></li>
<li><p>定义Cookies</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Python">url = <span class="hljs-string">&#x27;http://httpbin.org/cookies&#x27;</span><br>cookies = &#123;<span class="hljs-string">&#x27;cookies_are&#x27;</span>: <span class="hljs-string">&#x27;working&#x27;</span>&#125;<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> ClientSession(cookies=cookies) <span class="hljs-keyword">as</span> session:<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(url) <span class="hljs-keyword">as</span> resp:<br>        <span class="hljs-keyword">assert</span> <span class="hljs-keyword">await</span> resp.json() == &#123;<br>           <span class="hljs-string">&quot;cookies&quot;</span>: &#123;<span class="hljs-string">&quot;cookies_are&quot;</span>: <span class="hljs-string">&quot;working&quot;</span>&#125;&#125;<br></code></pre></td></tr></table></figure>
<h3 id="发送表单请求"><a href="#发送表单请求" class="headerlink" title="发送表单请求"></a>发送表单请求</h3><p>在session.post()方法中通过定义data可以设置表单的内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Python">payload = &#123;<span class="hljs-string">&#x27;key1&#x27;</span>: <span class="hljs-string">&#x27;value1&#x27;</span>, <span class="hljs-string">&#x27;key2&#x27;</span>: <span class="hljs-string">&#x27;value2&#x27;</span>&#125;<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.post(<span class="hljs-string">&#x27;http://httpbin.org/post&#x27;</span>,<br>                        data=payload) <span class="hljs-keyword">as</span> resp:<br>    print(<span class="hljs-keyword">await</span> resp.text())<br></code></pre></td></tr></table></figure>
<h3 id="发送文件"><a href="#发送文件" class="headerlink" title="发送文件"></a>发送文件</h3><p>在发送文件时，也可以通过定义filename和content-type来设置文件名和类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Python">url = <span class="hljs-string">&#x27;http://httpbin.org/post&#x27;</span><br>data = FormData()<br>data.add_field(<span class="hljs-string">&#x27;file&#x27;</span>,<br>               <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;report.xls&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>),<br>               filename=<span class="hljs-string">&#x27;report.xls&#x27;</span>,<br>               content_type=<span class="hljs-string">&#x27;application/vnd.ms-excel&#x27;</span>)<br><br><span class="hljs-keyword">await</span> session.post(url, data=data)<br></code></pre></td></tr></table></figure>
<h3 id="发送大文件"><a href="#发送大文件" class="headerlink" title="发送大文件"></a>发送大文件</h3><p>如果文件过大，可以通过流的形式进行上传</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;massive-body&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>   <span class="hljs-keyword">await</span> session.post(<span class="hljs-string">&#x27;http://httpbin.org/post&#x27;</span>, data=f)<br></code></pre></td></tr></table></figure>
<p>或者可以使用@aiohttp.streamer装饰器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@aiohttp.streamer</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">file_sender</span>(<span class="hljs-params">writer, file_name=<span class="hljs-literal">None</span></span>):</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_name, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        chunk = f.read(<span class="hljs-number">2</span>**<span class="hljs-number">16</span>)<br>        <span class="hljs-keyword">while</span> chunk:<br>            <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> writer.write(chunk)<br>            chunk = f.read(<span class="hljs-number">2</span>**<span class="hljs-number">16</span>)<br><br><span class="hljs-comment"># Then you can use `file_sender` as a data provider:</span><br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.post(<span class="hljs-string">&#x27;http://httpbin.org/post&#x27;</span>,<br>                        data=file_sender(file_name=<span class="hljs-string">&#x27;huge_file&#x27;</span>)) <span class="hljs-keyword">as</span> resp:<br>    print(<span class="hljs-keyword">await</span> resp.text())<br></code></pre></td></tr></table></figure>
<p>也可以使用StreamReader对象进行上传，比如从一个请求下来的内容再上传回去</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">feed_stream</span>(<span class="hljs-params">resp, stream</span>):</span><br>    h = hashlib.sha256()<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        chunk = <span class="hljs-keyword">await</span> resp.content.readany()<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> chunk:<br>            <span class="hljs-keyword">break</span><br>        h.update(chunk)<br>        stream.feed_data(chunk)<br><br>    <span class="hljs-keyword">return</span> h.hexdigest()<br><br>resp = session.get(<span class="hljs-string">&#x27;http://httpbin.org/post&#x27;</span>)<br>stream = StreamReader()<br>loop.create_task(session.post(<span class="hljs-string">&#x27;http://httpbin.org/post&#x27;</span>, data=stream))<br><br>file_hash = <span class="hljs-keyword">await</span> feed_stream(resp, stream)<br></code></pre></td></tr></table></figure>
<h3 id="上传预压缩的数据"><a href="#上传预压缩的数据" class="headerlink" title="上传预压缩的数据"></a>上传预压缩的数据</h3><p>要将传递给aiohttp之前已压缩的数据上传，请使用所使用的压缩算法名称（通常是deflate或zlib）作为Content-Encoding头的值来调用请求函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">my_coroutine</span>(<span class="hljs-params">session, headers, my_data</span>):</span><br>    data = zlib.compress(my_data)<br>    headers = &#123;<span class="hljs-string">&#x27;Content-Encoding&#x27;</span>: <span class="hljs-string">&#x27;deflate&#x27;</span>&#125;<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.post(<span class="hljs-string">&#x27;http://httpbin.org/post&#x27;</span>,<br>                            data=data,<br>                            headers=headers)<br>        <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure>
<h3 id="连接池，Keep-Alive和-cookie共享"><a href="#连接池，Keep-Alive和-cookie共享" class="headerlink" title="连接池，Keep-Alive和 cookie共享"></a>连接池，Keep-Alive和 cookie共享</h3><p>ClientSession 支持保持活动的请求和连接池的开箱即用<br>ClientSession 可用于在多个请求之间共享cookie</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<br>    <span class="hljs-keyword">await</span> session.get(<br>        <span class="hljs-string">&#x27;http://httpbin.org/cookies/set?my_cookie=my_value&#x27;</span>)<br>    filtered = session.cookie_jar.filter_cookies(<span class="hljs-string">&#x27;http://httpbin.org&#x27;</span>)<br>    <span class="hljs-keyword">assert</span> filtered[<span class="hljs-string">&#x27;my_cookie&#x27;</span>].value == <span class="hljs-string">&#x27;my_value&#x27;</span><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&#x27;http://httpbin.org/cookies&#x27;</span>) <span class="hljs-keyword">as</span> r:<br>        json_body = <span class="hljs-keyword">await</span> r.json()<br>        <span class="hljs-keyword">assert</span> json_body[<span class="hljs-string">&#x27;cookies&#x27;</span>][<span class="hljs-string">&#x27;my_cookie&#x27;</span>] == <span class="hljs-string">&#x27;my_value&#x27;</span><br></code></pre></td></tr></table></figure>
<p>还可以为所有会话请求设置默认标题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession(<br>    headers=&#123;<span class="hljs-string">&quot;Authorization&quot;</span>: <span class="hljs-string">&quot;Basic bG9naW46cGFzcw==&quot;</span>&#125;) <span class="hljs-keyword">as</span> session:<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&quot;http://httpbin.org/headers&quot;</span>) <span class="hljs-keyword">as</span> r:<br>        json_body = <span class="hljs-keyword">await</span> r.json()<br>        <span class="hljs-keyword">assert</span> json_body[<span class="hljs-string">&#x27;headers&#x27;</span>][<span class="hljs-string">&#x27;Authorization&#x27;</span>] == \<br>            <span class="hljs-string">&#x27;Basic bG9naW46cGFzcw==&#x27;</span><br></code></pre></td></tr></table></figure>
<h3 id="cookie安全"><a href="#cookie安全" class="headerlink" title="cookie安全"></a>cookie安全</h3><p>RFC 2109明确禁止Cookie使用IP地址而不是DNS名称来接受URL（例如 <a target="_blank" rel="noopener" href="http://127.0.0.1/cookie%EF%BC%89%E3%80%82">http://127.0.0.1:80/cookie）。</a><br>默认情况下ClientSession通过aiohttp.CookieJar提供该功能。<br>通过将unsafe = True传递给 aiohttp.CookieJar构造函数来完成，启用对这种cookie的支持</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Python">jar = aiohttp.CookieJar(unsafe=<span class="hljs-literal">True</span>)<br>session = aiohttp.ClientSession(cookie_jar=jar)<br></code></pre></td></tr></table></figure>
<h3 id="连接器"><a href="#连接器" class="headerlink" title="连接器"></a>连接器</h3><p>要调整或更改传输层的请求，您可以将自定义连接器传递 给ClientSession</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Python">conn = aiohttp.TCPConnector()<br>session = aiohttp.ClientSession(connector=conn)<br></code></pre></td></tr></table></figure>
<h3 id="通过连机器限制连接池大小"><a href="#通过连机器限制连接池大小" class="headerlink" title="通过连机器限制连接池大小"></a>通过连机器限制连接池大小</h3><p>默认是100个请求，但可以通过limit来设置连接池大小，如果limit是0则代表无限制</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Python">conn = aiohttp.TCPConnector(limit=<span class="hljs-number">30</span>)<br></code></pre></td></tr></table></figure>
<p>如果要限制同时打开链接到同一个端点的数量，可以将limit_per_host 参数传递给连接器((host, port, is_ssl) triple)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">conn = aiohttp.TCPConnector(limit_per_host=<span class="hljs-number">30</span>)<br></code></pre></td></tr></table></figure>
<h3 id="使用自定义名称服务器解析"><a href="#使用自定义名称服务器解析" class="headerlink" title="使用自定义名称服务器解析"></a>使用自定义名称服务器解析</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> aiohttp.resolver <span class="hljs-keyword">import</span> AsyncResolver<br><br>resolver = AsyncResolver(nameservers=[<span class="hljs-string">&quot;8.8.8.8&quot;</span>, <span class="hljs-string">&quot;8.8.4.4&quot;</span>])<br>conn = aiohttp.TCPConnector(resolver=resolver)<br></code></pre></td></tr></table></figure>
<p>默认情况下，aiohttp使用严格的HTTPS协议检查。通过将verify_ssl设置为False可以放宽认证检查</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">r = <span class="hljs-keyword">await</span> session.get(<span class="hljs-string">&#x27;https://example.com&#x27;</span>, verify_ssl=<span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure>
<p>如果需要设置自定义ssl参数（例如使用自己的认证文件），您可以创建一个ssl.SSLContext实例并将其传递给ClientSession方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">sslcontext = ssl.create_default_context(<br>   cafile=<span class="hljs-string">&#x27;/path/to/ca-bundle.crt&#x27;</span>)<br>r = <span class="hljs-keyword">await</span> session.get(<span class="hljs-string">&#x27;https://example.com&#x27;</span>, ssl_context=sslcontext)<br></code></pre></td></tr></table></figure>
<p>如果您需要验证自签名证书，则可以执行与上一个示例相同的操作，但可以使用ssl.SSLContext.load_cert_chain()添加密钥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">sslcontext = ssl.create_default_context(<br>   cafile=<span class="hljs-string">&#x27;/path/to/ca-bundle.crt&#x27;</span>)<br>sslcontext.load_cert_chain(<span class="hljs-string">&#x27;/path/to/client/public/device.pem&#x27;</span>,<br>                           <span class="hljs-string">&#x27;/path/to/client/private/device.jey&#x27;</span>)<br>r = <span class="hljs-keyword">await</span> session.get(<span class="hljs-string">&#x27;https://example.com&#x27;</span>, ssl_context=sslcontext)<br></code></pre></td></tr></table></figure>
<p>ssl验证失败时会有明显的错误</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#aiohttp.ClientConnectorSSLError:</span><br><br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-keyword">await</span> session.get(<span class="hljs-string">&#x27;https://expired.badssl.com/&#x27;</span>)<br><span class="hljs-keyword">except</span> aiohttp.ClientConnectorSSLError <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(e, ssl.SSLError)<br></code></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#aiohttp.ClientConnectorCertificateError:</span><br><br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-keyword">await</span> session.get(<span class="hljs-string">&#x27;https://wrong.host.badssl.com/&#x27;</span>)<br><span class="hljs-keyword">except</span> aiohttp.ClientConnectorCertificateError <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(e, ssl.CertificateError)<br></code></pre></td></tr></table></figure>
<p>如果需要跳过两个SSL相关的错误</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#aiohttp.ClientSSLError:</span><br><br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-keyword">await</span> session.get(<span class="hljs-string">&#x27;https://expired.badssl.com/&#x27;</span>)<br><span class="hljs-keyword">except</span> aiohttp.ClientSSLError <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(e, ssl.SSLError)<br><br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-keyword">await</span> session.get(<span class="hljs-string">&#x27;https://wrong.host.badssl.com/&#x27;</span>)<br><span class="hljs-keyword">except</span> aiohttp.ClientSSLError <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(e, ssl.CertificateError)<br></code></pre></td></tr></table></figure>
<p>也可以通过SHA256验证</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Attempt to connect to https://www.python.org</span><br><span class="hljs-comment"># with a pin to a bogus certificate:</span><br>bad_fingerprint = <span class="hljs-string">b&#x27;0&#x27;</span>*<span class="hljs-number">64</span><br>exc = <span class="hljs-literal">None</span><br><span class="hljs-keyword">try</span>:<br>    r = <span class="hljs-keyword">await</span> session.get(<span class="hljs-string">&#x27;https://www.python.org&#x27;</span>,<br>                          fingerprint=bad_fingerprint)<br><span class="hljs-keyword">except</span> aiohttp.FingerprintMismatch <span class="hljs-keyword">as</span> e:<br>    exc = e<br><span class="hljs-keyword">assert</span> exc <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br><span class="hljs-keyword">assert</span> exc.expected == bad_fingerprint<br><br><span class="hljs-comment"># www.python.org cert&#x27;s actual fingerprint</span><br><span class="hljs-keyword">assert</span> exc.got == <span class="hljs-string">b&#x27;...&#x27;</span><br></code></pre></td></tr></table></figure>
<h3 id="Unix域名sockets"><a href="#Unix域名sockets" class="headerlink" title="Unix域名sockets"></a>Unix域名sockets</h3><p>如果您的HTTP服务器使用UNIX域名sockets，则可以使用 UnixConnector：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Python">conn = aiohttp.UnixConnector(path=<span class="hljs-string">&#x27;/path/to/socket&#x27;</span>)<br>session = aiohttp.ClientSession(connector=conn)<br></code></pre></td></tr></table></figure>
<h3 id="使用代理"><a href="#使用代理" class="headerlink" title="使用代理"></a>使用代理</h3><blockquote>
<p>原话:aiohttp supports支持http/https 代理</p>
</blockquote>
</li>
</ul>
<p>然而使用时如果有https代理,会说只支持http代理- -…</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&quot;http://python.org&quot;</span>,<br>                           proxy=<span class="hljs-string">&quot;http://some.proxy.com&quot;</span>) <span class="hljs-keyword">as</span> resp:<br>        print(resp.status)<br></code></pre></td></tr></table></figure>
<p>如果代理需要账户密码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<br>    proxy_auth = aiohttp.BasicAuth(<span class="hljs-string">&#x27;user&#x27;</span>, <span class="hljs-string">&#x27;pass&#x27;</span>)<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&quot;http://python.org&quot;</span>,<br>                           proxy=<span class="hljs-string">&quot;http://some.proxy.com&quot;</span>,<br>                           proxy_auth=proxy_auth) <span class="hljs-keyword">as</span> resp:<br>        print(resp.status)<br></code></pre></td></tr></table></figure>
<p>不过与requests库相反，它不会默认读取环境变量。但是，您以通过 trust_env=True传入aiohttp.ClientSession 构造函数来从HTTP_PROXY或HTTPS_PROXY 环境变量中提取代理配置 （两者都不区分大小写）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&quot;http://python.org&quot;</span>, trust_env=<span class="hljs-literal">True</span>) <span class="hljs-keyword">as</span> resp:<br>        print(resp.status)<br></code></pre></td></tr></table></figure>
<h3 id="响应状态码"><a href="#响应状态码" class="headerlink" title="响应状态码"></a>响应状态码</h3><p>可以通过如下查看状态码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&#x27;http://httpbin.org/get&#x27;</span>) <span class="hljs-keyword">as</span> resp:<br>    <span class="hljs-keyword">assert</span> resp.status == <span class="hljs-number">200</span><br></code></pre></td></tr></table></figure>
<h3 id="请求头"><a href="#请求头" class="headerlink" title="请求头"></a>请求头</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-meta">&gt;&gt;&gt; </span>resp.headers<br>&#123;<span class="hljs-string">&#x27;ACCESS-CONTROL-ALLOW-ORIGIN&#x27;</span>: <span class="hljs-string">&#x27;*&#x27;</span>,<br> <span class="hljs-string">&#x27;CONTENT-TYPE&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>,<br> <span class="hljs-string">&#x27;DATE&#x27;</span>: <span class="hljs-string">&#x27;Tue, 15 Jul 2014 16:49:51 GMT&#x27;</span>,<br> <span class="hljs-string">&#x27;SERVER&#x27;</span>: <span class="hljs-string">&#x27;gunicorn/18.0&#x27;</span>,<br> <span class="hljs-string">&#x27;CONTENT-LENGTH&#x27;</span>: <span class="hljs-string">&#x27;331&#x27;</span>,<br> <span class="hljs-string">&#x27;CONNECTION&#x27;</span>: <span class="hljs-string">&#x27;keep-alive&#x27;</span>&#125;<br></code></pre></td></tr></table></figure>
<p>虽然是http文件，但是一份特殊的dict根据RFC 7230，HTTP标头名称是不区分大小写的。它也支持与HTTP协议相同的密钥的多个值。<br>所以，我们可以使用任何我们想要的大小来访问头文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-meta">&gt;&gt;&gt; </span>resp.headers[<span class="hljs-string">&#x27;Content-Type&#x27;</span>]<br><span class="hljs-string">&#x27;application/json&#x27;</span><br><br><span class="hljs-meta">&gt;&gt;&gt; </span>resp.headers.get(<span class="hljs-string">&#x27;content-type&#x27;</span>)<br><span class="hljs-string">&#x27;application/json&#x27;</span><br></code></pre></td></tr></table></figure>
<p>都使用UTF-8从二进制数据转换为 surrogateescape选项。这在大多数情况下工作正常，但有时如果服务器使用非标准编码，则需要未转换的数据，可以通过使用ClientResponse.raw_headers属性来检索 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-meta">&gt;&gt;&gt; </span>resp.raw_headers<br>((<span class="hljs-string">b&#x27;SERVER&#x27;</span>, <span class="hljs-string">b&#x27;nginx&#x27;</span>),<br> (<span class="hljs-string">b&#x27;DATE&#x27;</span>, <span class="hljs-string">b&#x27;Sat, 09 Jan 2016 20:28:40 GMT&#x27;</span>),<br> (<span class="hljs-string">b&#x27;CONTENT-TYPE&#x27;</span>, <span class="hljs-string">b&#x27;text/html; charset=utf-8&#x27;</span>),<br> (<span class="hljs-string">b&#x27;CONTENT-LENGTH&#x27;</span>, <span class="hljs-string">b&#x27;12150&#x27;</span>),<br> (<span class="hljs-string">b&#x27;CONNECTION&#x27;</span>, <span class="hljs-string">b&#x27;keep-alive&#x27;</span>))<br></code></pre></td></tr></table></figure>
<h3 id="获取请求的cookie"><a href="#获取请求的cookie" class="headerlink" title="获取请求的cookie"></a>获取请求的cookie</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Python">url = <span class="hljs-string">&#x27;http://example.com/some/cookie/setting/url&#x27;</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(url) <span class="hljs-keyword">as</span> resp:<br>    print(resp.cookies[<span class="hljs-string">&#x27;example_cookie_name&#x27;</span>])<br></code></pre></td></tr></table></figure>
<p>注意<br>响应cookie仅包含重定向链中最后一个请求Set-Cookie中的值。要在所有重定向请求之间收集cookie，请使用aiohttp.ClientSession对象</p>
<h3 id="请求历史"><a href="#请求历史" class="headerlink" title="请求历史"></a>请求历史</h3><p>如果请求被重定向，则可以使用history属性查看之前的响应</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>resp  =  等待 会话。get （<span class="hljs-string">&#x27;http://example.com/some/redirect/&#x27;</span> ）<br><span class="hljs-meta">&gt;&gt;&gt; </span>resp <br>&lt;ClientResponse（http://example.com/some/other/url/）[<span class="hljs-number">200</span>]&gt; <br><span class="hljs-meta">&gt;&gt;&gt; </span>resp 。历史<br>（&lt;ClientResponse（http://example.com/some/redirect/）[<span class="hljs-number">301</span>]&gt;）<br></code></pre></td></tr></table></figure>
<p>如果没有发生重定向或allow_redirects设置为False，历史记录将是一个空的序列</p>
<h3 id="WebSockets"><a href="#WebSockets" class="headerlink" title="WebSockets"></a>WebSockets</h3><p>在aiohttp中WebSockets是开箱即用的，但是必须使用aiohttp.ClientSession.ws_connect()协程来进行客户端websocket连接。它接受一个url作为第一个参数并返回ClientWebSocketResponse，通过该对象，你可以使用响应的方法与websocket服务器进行通信</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">session = aiohttp.ClientSession()<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.ws_connect(<span class="hljs-string">&#x27;http://example.org/websocket&#x27;</span>) <span class="hljs-keyword">as</span> ws:<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> ws:<br>        <span class="hljs-keyword">if</span> msg.<span class="hljs-built_in">type</span> == aiohttp.WSMsgType.TEXT:<br>            <span class="hljs-keyword">if</span> msg.data == <span class="hljs-string">&#x27;close cmd&#x27;</span>:<br>                <span class="hljs-keyword">await</span> ws.close()<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">await</span> ws.send_str(msg.data + <span class="hljs-string">&#x27;/answer&#x27;</span>)<br>        <span class="hljs-keyword">elif</span> msg.<span class="hljs-built_in">type</span> == aiohttp.WSMsgType.CLOSED:<br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">elif</span> msg.<span class="hljs-built_in">type</span> == aiohttp.WSMsgType.ERROR:<br>            <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure>
<p>注意:只能使用一个websocket任务进行读写(如await ws.receive() 和 async for msg in ws:)<br>但是可以使用多个异步读写数据(如:ws.send_str(‘data’)</p>
<h3 id="超时"><a href="#超时" class="headerlink" title="超时"></a>超时</h3><p>默认情况下所有IO操作都有5分钟的超时时间 可以通过传入timeout参数到ClientSession.get()来设置超时，当设置None或0时，禁用超时检查</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&#x27;https://github.com&#x27;</span>, timeout=<span class="hljs-number">60</span>) <span class="hljs-keyword">as</span> r:<br></code></pre></td></tr></table></figure>
<p>如果是按流的形式写入数据，可以使用async_timeout.timeout()，为连接和响应正文读取过程添加了超时</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> async_timeout<br><br><span class="hljs-keyword">with</span> async_timeout.timeout(<span class="hljs-number">0.001</span>):<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&#x27;https://github.com&#x27;</span>) <span class="hljs-keyword">as</span> r:<br>        <span class="hljs-keyword">await</span> r.text()<br></code></pre></td></tr></table></figure>
<p>注意的是超时是累计时间，包括发送请求，重定向，响应解析，消费响应等所有操作。</p>
<h3 id="优雅的关闭-就是比较好的关闭协程？？？"><a href="#优雅的关闭-就是比较好的关闭协程？？？" class="headerlink" title="优雅的关闭(就是比较好的关闭协程？？？)"></a>优雅的关闭(就是比较好的关闭协程？？？)</h3><p>当ClientSession在块的末尾关闭（或通过直接调用）时，由于asyncio内部细节，基础连接保持打开状态在实践中，基础连接将在一段时间后关闭。但是，如果事件循环在底层连接关闭之前停止，则会发出警告（启用警告时）:</p>
<blockquote>
<p>async with.close()ResourceWarning: unclosed transport</p>
</blockquote>
<p>为了避免这种情况，必须在关闭事件循环之前添加一个小的延迟，以允许任何打开的底层连接关闭<br>对于ClientSession没有使用SSL：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">read_website</span>():</span><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<br>        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&#x27;http://example.org/&#x27;</span>) <span class="hljs-keyword">as</span> response:<br>            <span class="hljs-keyword">await</span> response.read()<br><br>loop = asyncio.get_event_loop()<br>loop.run_until_complete(read_website())<br><span class="hljs-comment"># Zero-sleep to allow underlying connections to close</span><br>loop.run_until_complete(asyncio.sleep(<span class="hljs-number">0</span>))<br>loop.close()<br></code></pre></td></tr></table></figure>
<p>对于ClientSession使用SSL，在结束之前必须等待很短的时间：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">read_website</span>():</span><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<br>        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&#x27;http://example.org/&#x27;</span>) <span class="hljs-keyword">as</span> response:<br>            <span class="hljs-keyword">await</span> response.read()<br><br>loop = asyncio.get_event_loop()<br>loop.run_until_complete(read_website())<br>loop.run_until_complete(asyncio.sleep(<span class="hljs-number">0.250</span>))<br>loop.close()<br></code></pre></td></tr></table></figure>
      </section>
      <section class="extra">
        
          <ul class="copyright">
  
    <li><strong>本文作者：</strong>So1n</li>
    <li><strong>本文链接：</strong><a href="http://so1n.me/2017/12/29/26_tr_aiohttp/index.html" title="http:&#x2F;&#x2F;so1n.me&#x2F;2017&#x2F;12&#x2F;29&#x2F;26_tr_aiohttp&#x2F;index.html">http:&#x2F;&#x2F;so1n.me&#x2F;2017&#x2F;12&#x2F;29&#x2F;26_tr_aiohttp&#x2F;index.html</a></li>
    <li><strong>版权声明：</strong>本博客所有文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" title="BY-NC-SA" target="_blank" rel="noopener">BY-NC-SA</a> 许可协议，转载请注明出处！</li>
  
</ul>
        
        
          <section class="donate">
  <div id="qrcode-donate">
    <img   class="lazyload" data-original="https://pic.izhaoo.com/alipay.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" >
  </div>
  <div class="icon">
    <a href="javascript:;" id="alipay"><i class="iconfont iconalipay"></i></a>
    <a href="javascript:;" id="wechat"><i class="iconfont iconwechat-fill"></i></a>
  </div>
</section>
        
        
  <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/aiohttp/" rel="tag">aiohttp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li></ul> 

        
  <nav class="nav">
    <a href="/2017/12/30/27_tr_redis_py/"><i class="iconfont iconleft"></i>redis-py</a>
    <a href="/2017/12/26/25_how_to_design_RESTurl/">设计RESTful(flask)<i class="iconfont iconright"></i></a>
  </nav>

      </section>
      
        <section class="comments">
  
    <div class="btn" id="comments-btn">查看评论</div>
  
  
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<div id="gitalk" class="gitalk"></div>
<script defer src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
  window.onload = function () {
    var gitalk = new Gitalk({
      clientID: '59f804e526b05c378470',
      clientSecret: '36679ff697cec424936a0f7c4bcd6d2988dac28e',
      id: window.location.pathname,
      repo: 'so1n.github.io',
      owner: 'so1n',
      admin: 'so1n'
    });
    if ( true ) {
      $("#comments-btn").on("click", function () {
        $(this).hide();
        gitalk.render('gitalk');
      });
    } else {
      gitalk.render('gitalk');
    }
  }
</script>

</section>
      
    </section>
  </div>
</article></div>
      <div class="col-xl-3">
        
          
  <aside class="toc-wrap">
    <h3 class="toc-title">文章目录：</h3>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%AE%B0"><span class="toc-text">前记</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E9%97%A8"><span class="toc-text">入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8aiohttp%E8%BF%9B%E8%A1%8C%E8%AF%B7%E6%B1%82"><span class="toc-text">使用aiohttp进行请求</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E5%87%BA%E8%AF%B7%E6%B1%82"><span class="toc-text">提出请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JSON%E8%AF%B7%E6%B1%82"><span class="toc-text">JSON请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8url%E4%B8%AD%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0"><span class="toc-text">在url中传递参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-text">解析的内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E7%9A%84%E4%BF%A1%E6%81%AF-Headers%EF%BC%8CCookies"><span class="toc-text">请求的信息(Headers，Cookies)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E8%A1%A8%E5%8D%95%E8%AF%B7%E6%B1%82"><span class="toc-text">发送表单请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%96%87%E4%BB%B6"><span class="toc-text">发送文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E5%A4%A7%E6%96%87%E4%BB%B6"><span class="toc-text">发送大文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E9%A2%84%E5%8E%8B%E7%BC%A9%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-text">上传预压缩的数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0%EF%BC%8CKeep-Alive%E5%92%8C-cookie%E5%85%B1%E4%BA%AB"><span class="toc-text">连接池，Keep-Alive和 cookie共享</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cookie%E5%AE%89%E5%85%A8"><span class="toc-text">cookie安全</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E5%99%A8"><span class="toc-text">连接器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E8%BF%9E%E6%9C%BA%E5%99%A8%E9%99%90%E5%88%B6%E8%BF%9E%E6%8E%A5%E6%B1%A0%E5%A4%A7%E5%B0%8F"><span class="toc-text">通过连机器限制连接池大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E5%90%8D%E7%A7%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A7%A3%E6%9E%90"><span class="toc-text">使用自定义名称服务器解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Unix%E5%9F%9F%E5%90%8Dsockets"><span class="toc-text">Unix域名sockets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%BB%A3%E7%90%86"><span class="toc-text">使用代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%8D%E5%BA%94%E7%8A%B6%E6%80%81%E7%A0%81"><span class="toc-text">响应状态码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%A4%B4"><span class="toc-text">请求头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E7%9A%84cookie"><span class="toc-text">获取请求的cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%8E%86%E5%8F%B2"><span class="toc-text">请求历史</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebSockets"><span class="toc-text">WebSockets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E6%97%B6"><span class="toc-text">超时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E9%9B%85%E7%9A%84%E5%85%B3%E9%97%AD-%E5%B0%B1%E6%98%AF%E6%AF%94%E8%BE%83%E5%A5%BD%E7%9A%84%E5%85%B3%E9%97%AD%E5%8D%8F%E7%A8%8B%EF%BC%9F%EF%BC%9F%EF%BC%9F"><span class="toc-text">优雅的关闭(就是比较好的关闭协程？？？)</span></a></li></ol></li></ol>
  </aside>

        
      </div>
    </div>
  </div>
</main>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>


<footer class="footer">
  <div class="footer-social"><a 
        href="https://github.com/so1n "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#9f7be1'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  icongithub-fill "></i>
      </a></div>
  
    <div class="footer-copyright"><p>Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme - <a target="_blank" href="https://github.com/izhaoo/hexo-theme-zhaoo">zhaoo</a></p></div>
  
  <div class="footer-copyright">
    总访问量<span id="busuanzi_value_site_pv"></span>次
    访客数<span id="busuanzi_value_site_uv"></span>人次
  </div>

</footer>

  
      <div class="fab fab-plus">
    <i class="iconfont iconplus"></i>
  </div>
  
  
  <div class="fab fab-up">
    <i class="iconfont iconcaret-up"></i>
  </div>
  
  
    <div class="scrollbar j-scrollbar">
  <div class="scrollbar-current j-scrollbar-current"></div>
</div>
  
  
    
<script src="/js/color-mode.js"></script>

  
</body>

<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>



  
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>




  
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>






  
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>




<script src="/js/utils.js"></script>
<script src="/js/script.js"></script>







  <script>
    (function () {
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>













</html>