

<!DOCTYPE html>
<html lang="zh-Hans" color-mode=light>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>由内存溢出的思考:如何监控内存? - So1n blog</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="google" content="notranslate" />
  
  <meta name="description" content="前记最近在做监控系统,发现Linux的内存监控比较困难...">
  <meta name="author" content="So1n">
  <link rel="icon" href="/images/icons/favicon.ico" type="image/png" sizes="16x16">
  <link rel="icon" href="/images/icons/favicon.ico" type="image/png" sizes="32x32">
  <link rel="apple-touch-icon" href="/images/icons/favicon.ico" sizes="180x180">
  <meta rel="mask-icon" href="/images/icons/stun-logo.svg" color="#333333">
  
    <meta rel="msapplication-TileImage" content="/images/icons/favicon.ico">
    <meta rel="msapplication-TileColor" content="#000000">
  

  
<link rel="stylesheet" href="/css/style.css">


  
    
<link rel="stylesheet" href="//at.alicdn.com/t/font_1445822_s6x2xcokxrl.css">

  

  
    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css">

  

  
    
      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/atom-one-dark.min.css" name="highlight-style" mode="light">

      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/atom-one-dark.min.css" name="highlight-style" mode="dark">

      
  

  <script>
    var CONFIG = window.CONFIG || {};
    var ZHAOO = window.ZHAOO || {};
    CONFIG = {
      isHome: false,
      fancybox: true,
      pjax: false,
      lazyload: {
        enable: true,
        only_post: 'false',
        loading: '/images/theme/loading.gif'
      },
      donate: {
        enable: true,
        alipay: 'https://github.com/so1n/so1n_blog_photo/blob/master/blog_photo/4d2ebf32586d8799ee2e75333d6f5d2.jpg?raw=true',
        wechat: ''
      },
      galleries: {
        enable: true
      },
      fab: {
        enable: true,
        always_show: true
      },
      carrier: {
        enable: false
      },
      daovoice: {
        enable: false
      },
      preview: {
        background: {
          default: '/images/theme/welcome-image.jpg',
          api: 'https://source.unsplash.com/random/1920x1080'
        },
        motto: {
          default: '我们总说社会是个大染缸 其实是我们自己掉色',
          api: '',
          data_contents: '["data","content"]'
        },
      },
      qrcode: {
        enable: true,
        type: 'url',
        image: 'https://pic.izhaoo.com/weapp-code.jpg',
      },
      toc: {
        enable: true
      },
      scrollbar: {
        type: 'simple'
      },
      notification: {
        enable: false,
        delay: 4500,
        list: '',
        page_white_list: '',
        page_black_list: ''
      }
    }
  </script>

  

  

<meta name="generator" content="Hexo 5.3.0"></head>

<body class="lock-screen">
  <div class="loading"></div>
  


  <nav class="navbar">
    <div class="left">
      
        <i class="iconfont iconqrcode j-navbar-qrcode"></i>
      
      
        <i class="iconfont iconmoono" id="color-toggle" color-toggle="light"></i>
      
    </div>
    <div class="center">由内存溢出的思考:如何监控内存?</div>
    <div class="right">
      <i class="iconfont iconmenu j-navbar-menu"></i>
    </div>
    
      <div id="qrcode-navbar"></div>
    
  </nav>

  

<nav class="menu">
  <div class="menu-wrap">
    <div class="menu-close">
      <i class="iconfont iconbaseline-close-px"></i>
    </div>
    <ul class="menu-content"><li class="menu-item">
        <a href="/ " class="underline "> 首页</a>
      </li><li class="menu-item">
        <a href="/galleries/ " class="underline "> 摄影</a>
      </li><li class="menu-item">
        <a target="_blank" rel="noopener" href="http://so1nz.lofter.com/ " class="underline "> 时光</a>
      </li><li class="menu-item">
        <a href="/archives/ " class="underline "> 归档</a>
      </li><li class="menu-item">
        <a href="/tags/ " class="underline "> 标签</a>
      </li><li class="menu-item">
        <a href="/categories/ " class="underline "> 分类</a>
      </li><li class="menu-item">
        <a href="/project/ " class="underline "> 项目</a>
      </li><li class="menu-item">
        <a href="/about/ " class="underline "> 关于</a>
      </li></ul>
    
      <div class="menu-copyright"><p>Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme - <a target="_blank" href="https://github.com/izhaoo/hexo-theme-zhaoo">zhaoo</a></p></div>
    
  </div>
</nav>
  <main id="main">
  <div class="article-wrap">
    <div class="row container">
      <div class="col-xl-3"></div>
      <div class="col-xl-6"><article class="article">
  <div class="wrap">
    <section class="head">
  <img   class="lazyload" data-original="/images/theme/post-image.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  draggable="false">
  <div class="head-mask">
    <h1 class="head-title">由内存溢出的思考:如何监控内存?</h1>
    <div class="head-info">
      <span class="post-info-item"><i class="iconfont iconcalendar"></i>May 28, 2020</span>
      
      本文总阅读量<span id="busuanzi_value_page_pv"></span>次
      <span class="post-info-item"><i class="iconfont iconfont-size"></i>9105</span>
    </div>
  </div>
</section>

    <section class="main">
      <section class="content">
        <h2 id="1-一次”内存报警异常”"><a href="#1-一次”内存报警异常”" class="headerlink" title="1.一次”内存报警异常”"></a>1.一次”内存报警异常”</h2><h3 id="1-1-问题"><a href="#1-1-问题" class="headerlink" title="1.1.问题"></a>1.1.问题</h3><p>最近监控一直在报某些机器内存异常,内存超过了90%的使用,登上去机器用<code>free -h</code>命令查看发现user部分确实很多,但通过<code>ps -aux | sort -l 4</code>发现所有进程加起来的内存占用都没有user的10分之一,究竟是谁在吃内存不得而知.</p>
<h3 id="1-2-排查问题机器"><a href="#1-2-排查问题机器" class="headerlink" title="1.2.排查问题机器"></a>1.2.排查问题机器</h3><h4 id="1-2-1-top"><a href="#1-2-1-top" class="headerlink" title="1.2.1.top"></a>1.2.1.top</h4><p>从top命令可以看出,目前最占用内存的进程只有supervisord,只占用了0.9%的内存,即使所有进程占用内存加起来,也占用到10-20%左右</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs tap">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                                                                                                          <br><span class="hljs-number"> 1230 </span>root     <span class="hljs-number"> 20 </span> <span class="hljs-number"> 0 </span> <span class="hljs-number"> 30040 </span><span class="hljs-number"> 18192 </span> <span class="hljs-number"> 1764 </span>S   0.0   0.9  73:32.80 supervisord                                                                                                      <br>27835 nobody   <span class="hljs-number"> 20 </span> <span class="hljs-number"> 0 </span> <span class="hljs-number"> 21248 </span><span class="hljs-number"> 11552 </span> <span class="hljs-number"> 1900 </span>S   3.3   0.6  18:15.34 so1n-server                                                                                                        <br>16045 nobody   <span class="hljs-number"> 20 </span> <span class="hljs-number"> 0 </span> <span class="hljs-number"> 18456 </span> <span class="hljs-number"> 8240 </span> <span class="hljs-number"> 1380 </span>S   1.0   0.4   3:45.40 so1n-server                                                                                                        <br>22880 root     <span class="hljs-number"> 20 </span> <span class="hljs-number"> 0 </span> <span class="hljs-number"> 16720 </span> <span class="hljs-number"> 8108 </span> <span class="hljs-number"> 6836 </span>S   0.0   0.4   0:01.83 sshd                                                                                                             <br> <span class="hljs-number"> 209 </span>root     <span class="hljs-number"> 20 </span> <span class="hljs-number"> 0 </span> <span class="hljs-number"> 44292 </span> <span class="hljs-number"> 8056 </span> <span class="hljs-number"> 4212 </span>S   0.0   0.4   5:36.02 systemd-journal  <br>.....<br></code></pre></td></tr></table></figure>
<h4 id="1-2-2-free"><a href="#1-2-2-free" class="headerlink" title="1.2.2. free"></a>1.2.2. free</h4><p>通过<code>free -h</code>命令可以看到 共2g内存的小机器,used已经使用了1.6g了 ,占用了80%了</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache">              <span class="hljs-attribute">total</span>        used        free      shared  buff/cache   available<br><span class="hljs-attribute">Mem</span>:          <span class="hljs-number">2</span>.<span class="hljs-number">0</span>Gi       <span class="hljs-number">1</span>.<span class="hljs-number">6</span>Gi       <span class="hljs-number">297</span>Mi        <span class="hljs-number">20</span>Mi        <span class="hljs-number">87</span>Mi       <span class="hljs-number">257</span>Mi<br><span class="hljs-attribute">Swap</span>:            <span class="hljs-number">0</span>B          <span class="hljs-number">0</span>B          <span class="hljs-number">0</span>B<br></code></pre></td></tr></table></figure>
<p>为了了解used的主要组成,先通过<code>man free</code>查看free各个字段的说明</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs tcl">DESCRIPTION<br>		......<br>       total  Total installed <span class="hljs-keyword">memory</span> (MemTotal and SwapTotal in /<span class="hljs-keyword">proc</span>/meminfo)<br><span class="hljs-title">       used</span> <span class="hljs-title">  Used</span> memory (calculated<span class="hljs-title"> as</span> total -<span class="hljs-title"> free</span> -<span class="hljs-title"> buffers</span> -<span class="hljs-title"> cache)</span><br><span class="hljs-title"></span> <span class="hljs-title">      free</span> <span class="hljs-title">  Unused</span> memory (MemFree<span class="hljs-title"> and</span> SwapFree<span class="hljs-title"> in</span> /<span class="hljs-keyword">proc</span>/meminfo)<br><span class="hljs-title">       shared</span> Memory<span class="hljs-title"> used</span> (mostly)<span class="hljs-title"> by</span> tmpfs (Shmem<span class="hljs-title"> in</span> /<span class="hljs-keyword">proc</span>/meminfo)<br><span class="hljs-title">       buffers</span><br><span class="hljs-title"></span> <span class="hljs-title">             Memory</span> used<span class="hljs-title"> by</span> kernel<span class="hljs-title"> buffers</span> (Buffers<span class="hljs-title"> in</span> /<span class="hljs-keyword">proc</span>/meminfo)<br><span class="hljs-title">       cache</span> <span class="hljs-title"> Memory</span> used<span class="hljs-title"> by</span> the<span class="hljs-title"> page</span> cache<span class="hljs-title"> and</span> slabs (Cached<span class="hljs-title"> and</span> SReclaimable<span class="hljs-title"> in</span> /<span class="hljs-keyword">proc</span>/meminfo)<br><span class="hljs-title">       buff/cache</span><br><span class="hljs-title"></span> <span class="hljs-title">             Sum</span> of<span class="hljs-title"> buffers</span> and<span class="hljs-title"> cache</span><br><span class="hljs-title"></span> <span class="hljs-title">      available</span><br><span class="hljs-title"></span> <span class="hljs-title">             Estimation</span> of<span class="hljs-title"> how</span> much<span class="hljs-title"> memory</span> is<span class="hljs-title"> available</span> for<span class="hljs-title"> starting</span> new<span class="hljs-title"> applications,</span> without<span class="hljs-title"> swapping.</span> Unlike<span class="hljs-title"> the</span> data<span class="hljs-title"> provided</span> by<span class="hljs-title"> the</span> cache<span class="hljs-title"> or</span> free<span class="hljs-title"> fields,</span> this<span class="hljs-title"> field</span> <span class="hljs-title"> takes</span><br><span class="hljs-title"></span> <span class="hljs-title">             into</span> <span class="hljs-title"> account</span> <span class="hljs-title"> page</span> <span class="hljs-title"> cache</span> <span class="hljs-title"> and</span> also<span class="hljs-title"> that</span> not<span class="hljs-title"> all</span> reclaimable<span class="hljs-title"> memory</span> slabs<span class="hljs-title"> will</span> be<span class="hljs-title"> reclaimed</span> due<span class="hljs-title"> to</span> items<span class="hljs-title"> being</span> in<span class="hljs-title"> use</span> (MemAvailable<span class="hljs-title"> in</span> /<span class="hljs-keyword">proc</span>/meminfo,<span class="hljs-title"> available</span> on<br><span class="hljs-title">              kernels</span> 3.14,<span class="hljs-title"> emulated</span> on<span class="hljs-title"> kernels</span> 2.6.27+,<span class="hljs-title"> otherwise</span> the<span class="hljs-title"> same</span> as<span class="hljs-title"> free)</span><br><span class="hljs-title"></span><br></code></pre></td></tr></table></figure>
<p>可以看出used是由total -free - buffes - cache计算得出,而cache又包括了Cached和SReclaimable,,所以used=total -free -buffers - Cached - SReclaimable.</p>
<h4 id="1-2-3-cat-proc-meminfo"><a href="#1-2-3-cat-proc-meminfo" class="headerlink" title="1.2.3. cat /proc/meminfo"></a>1.2.3. cat /proc/meminfo</h4><p>了解了free中used的计算后我们就可以自己根据/proc/meminfo查看有什么异常值,除去了计算used的free,buffers,Cached,SReclaimable后发现有一个叫SUnreclaim的值非常可疑,这个值表明的是存在于内核中的不可回收数据结构的大小, 存在与内核的数据结构有很多,比如创建一个TCP时,内核里面就会创建一个存TCP相关数据的数据结构,一般来说这个值的比较低的,而且是要低于SReclaimable(也是存在于内核中的数据结构的大小,不过是可回收的)的,所以需要进入Sunreclaim内部,查看是什么数据结构占用了比较多的内存</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs tcl">cat /<span class="hljs-keyword">proc</span>/meminfo <br>MemTotal:        2045852<span class="hljs-title"> kB</span><br><span class="hljs-title">MemFree:</span>          296104<span class="hljs-title"> kB</span><br><span class="hljs-title">MemAvailable:</span>     255252<span class="hljs-title"> kB</span><br><span class="hljs-title">Buffers:</span>            9348<span class="hljs-title"> kB</span><br><span class="hljs-title">Cached:</span>            58672<span class="hljs-title"> kB</span><br><span class="hljs-title">SwapCached:</span>            0<span class="hljs-title"> kB</span><br><span class="hljs-title">Active:</span>           118576<span class="hljs-title"> kB</span><br><span class="hljs-title">Inactive:</span>          29460<span class="hljs-title"> kB</span><br><span class="hljs-title">Active(anon):</span>      80200<span class="hljs-title"> kB</span><br><span class="hljs-title">Inactive(anon):</span>    20792<span class="hljs-title"> kB</span><br><span class="hljs-title">Active(file):</span>      38376<span class="hljs-title"> kB</span><br><span class="hljs-title">Inactive(file):</span>     8668<span class="hljs-title"> kB</span><br><span class="hljs-title">Unevictable:</span>           0<span class="hljs-title"> kB</span><br><span class="hljs-title">Mlocked:</span>               0<span class="hljs-title"> kB</span><br><span class="hljs-title">SwapTotal:</span>             0<span class="hljs-title"> kB</span><br><span class="hljs-title">SwapFree:</span>              0<span class="hljs-title"> kB</span><br><span class="hljs-title">Dirty:</span>                36<span class="hljs-title"> kB</span><br><span class="hljs-title">Writeback:</span>             0<span class="hljs-title"> kB</span><br><span class="hljs-title">AnonPages:</span>         80080<span class="hljs-title"> kB</span><br><span class="hljs-title">Mapped:</span>            18632<span class="hljs-title"> kB</span><br><span class="hljs-title">Shmem:</span>             20956<span class="hljs-title"> kB</span><br><span class="hljs-title">Slab:</span>             717036<span class="hljs-title"> kB</span><br><span class="hljs-title">SReclaimable:</span>      22040<span class="hljs-title"> kB</span><br><span class="hljs-title">SUnreclaim:</span>       694996<span class="hljs-title"> kB</span><br><span class="hljs-title">KernelStack:</span>        1308<span class="hljs-title"> kB</span><br><span class="hljs-title">PageTables:</span>         1880<span class="hljs-title"> kB</span><br><span class="hljs-title">NFS_Unstable:</span>          0<span class="hljs-title"> kB</span><br><span class="hljs-title">Bounce:</span>                0<span class="hljs-title"> kB</span><br><span class="hljs-title">WritebackTmp:</span>          0<span class="hljs-title"> kB</span><br><span class="hljs-title">CommitLimit:</span>     1022924<span class="hljs-title"> kB</span><br><span class="hljs-title">Committed_AS:</span>     210184<span class="hljs-title"> kB</span><br><span class="hljs-title">VmallocTotal:</span>   34359738367<span class="hljs-title"> kB</span><br><span class="hljs-title">VmallocUsed:</span>           0<span class="hljs-title"> kB</span><br><span class="hljs-title">VmallocChunk:</span>          0<span class="hljs-title"> kB</span><br><span class="hljs-title">Percpu:</span>              452<span class="hljs-title"> kB</span><br><span class="hljs-title">AnonHugePages:</span>     18432<span class="hljs-title"> kB</span><br><span class="hljs-title">ShmemHugePages:</span>        0<span class="hljs-title"> kB</span><br><span class="hljs-title">ShmemPmdMapped:</span>        0<span class="hljs-title"> kB</span><br><span class="hljs-title">HugePages_Total:</span>       0<br>HugePages_Free:        0<br>HugePages_Rsvd:        0<br>HugePages_Surp:        0<br>Hugepagesize:       2048<span class="hljs-title"> kB</span><br><span class="hljs-title">Hugetlb:</span>               0<span class="hljs-title"> kB</span><br><span class="hljs-title">DirectMap4k:</span>     1380324<span class="hljs-title"> kB</span><br><span class="hljs-title">DirectMap2M:</span>      716800<span class="hljs-title"> kB</span><br><span class="hljs-title">DirectMap1G:</span>           0<span class="hljs-title"> kB</span><br></code></pre></td></tr></table></figure>
<h4 id="1-2-4-slabtop"><a href="#1-2-4-slabtop" class="headerlink" title="1.2.4. slabtop"></a>1.2.4. slabtop</h4><p>slabtop可以查看slab(存放于内核的数据结构)的使用情况,可以发现有一个叫TCP的数据结构占用了600多M的内存,根据往常的使用经验,一个正常使用的TCP链接大概占4kb左右,这样算下来是这台机器打开了161392个TCP链接,显然是不对的(即使64kb, 换算下来也要1w个请求, 当前的请求量根本没那么多).所以需要对该问题进行修复,不过由于该问题是更改TCP参数造成的,跟主题不一样,所以关于内存异常的问题的调查就到这.</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">OBJS</span> ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME                   <br><span class="hljs-attribute">307968</span> <span class="hljs-number">307298</span>  <span class="hljs-number">99</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">02</span>K   <span class="hljs-number">1203</span>      <span class="hljs-number">256</span>      <span class="hljs-number">4812</span>K kmalloc-<span class="hljs-number">16</span><br><span class="hljs-attribute">302610</span> <span class="hljs-number">301633</span>  <span class="hljs-number">99</span>%    <span class="hljs-number">2</span>.<span class="hljs-number">12</span>K  <span class="hljs-number">20174</span>       <span class="hljs-number">15</span>    <span class="hljs-number">645568</span>K TCP<br> <span class="hljs-attribute">99519</span>  <span class="hljs-number">99519</span> <span class="hljs-number">100</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">19</span>K   <span class="hljs-number">4739</span>       <span class="hljs-number">21</span>     <span class="hljs-number">18956</span>K kmalloc-<span class="hljs-number">192</span><br> <span class="hljs-attribute">28056</span>  <span class="hljs-number">21510</span>  <span class="hljs-number">76</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">19</span>K   <span class="hljs-number">1336</span>       <span class="hljs-number">21</span>      <span class="hljs-number">5344</span>K dentry<br> <span class="hljs-attribute">18944</span>  <span class="hljs-number">16993</span>  <span class="hljs-number">89</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">03</span>K    <span class="hljs-number">148</span>      <span class="hljs-number">128</span>       <span class="hljs-number">592</span>K kmalloc-<span class="hljs-number">32</span><br> <span class="hljs-attribute">15390</span>  <span class="hljs-number">15390</span> <span class="hljs-number">100</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">13</span>K    <span class="hljs-number">513</span>       <span class="hljs-number">30</span>      <span class="hljs-number">2052</span>K kernfs_node_cache<br> <span class="hljs-attribute">13824</span>  <span class="hljs-number">13038</span>  <span class="hljs-number">94</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">06</span>K    <span class="hljs-number">216</span>       <span class="hljs-number">64</span>       <span class="hljs-number">864</span>K anon_vma_chain<br> <span class="hljs-attribute">10816</span>   <span class="hljs-number">8193</span>  <span class="hljs-number">75</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">06</span>K    <span class="hljs-number">169</span>       <span class="hljs-number">64</span>       <span class="hljs-number">676</span>K kmalloc-<span class="hljs-number">64</span><br>  <span class="hljs-attribute">9477</span>   <span class="hljs-number">9180</span>  <span class="hljs-number">96</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">59</span>K    <span class="hljs-number">729</span>       <span class="hljs-number">13</span>      <span class="hljs-number">5832</span>K inode_cache<br>  <span class="hljs-attribute">7923</span>   <span class="hljs-number">7915</span>  <span class="hljs-number">99</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">20</span>K    <span class="hljs-number">417</span>       <span class="hljs-number">19</span>      <span class="hljs-number">1668</span>K vm_area_struct<br>  <span class="hljs-attribute">7605</span>   <span class="hljs-number">6366</span>  <span class="hljs-number">83</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">10</span>K    <span class="hljs-number">195</span>       <span class="hljs-number">39</span>       <span class="hljs-number">780</span>K buffer_head<br>  <span class="hljs-attribute">7452</span>   <span class="hljs-number">7310</span>  <span class="hljs-number">98</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">09</span>K    <span class="hljs-number">162</span>       <span class="hljs-number">46</span>       <span class="hljs-number">648</span>K anon_vma<br>  <span class="hljs-attribute">4528</span>   <span class="hljs-number">3242</span>  <span class="hljs-number">71</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">25</span>K    <span class="hljs-number">283</span>       <span class="hljs-number">16</span>      <span class="hljs-number">1132</span>K filp<br>  <span class="hljs-attribute">4116</span>   <span class="hljs-number">4116</span> <span class="hljs-number">100</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">19</span>K    <span class="hljs-number">196</span>       <span class="hljs-number">21</span>       <span class="hljs-number">784</span>K uid_cache<br></code></pre></td></tr></table></figure>
<h2 id="2-要监控哪些内存"><a href="#2-要监控哪些内存" class="headerlink" title="2.要监控哪些内存"></a>2.要监控哪些内存</h2><p>通过上面的排查后,可以比较明确的是,内存监控不是单一指标,应该用一主多辅的指标进行监控(不然Linux内存那么多指标就是摆设了….)</p>
<p>主要指标当然是我们常说的内存使用占比了,根据free命令中的说明,我们一般都是用free的user/total来计算,也就是((MemTotal - (MemFree + Buffers + Cached + SReclaimable)) / MemTotal),但是这个计算会漏一些数据,比如上面所说的<code>SUnreclaim</code>以及/proc/meminfo里面的其他情况,同时Linux的页缓存也可能存在无法回收的情况.所以可以说这个指标也是不太准的.</p>
<p>那要怎么样才能把上面的情况考虑进去,尽量做一个所有服务都共有的内存监控呢,还记得free里有一个available字段,他的文档说明也说了,该字段是对一些可用内存进行统计,同时它会考虑 Page Cache 和无法回收的<code>SUnreclaim</code>的内存( 假设pagecache / 2 和 <code>SUnreclaim</code> / 2 是不可回收的)，最后估算出一个当前可用内存,来达到尽可能的与实际数据贴合.<br>所以实际的内存统计应该为( MemTotal - MemAvailable) / MemTotal,这样子会比原来的统计更加准确.</p>
<p>这样一来主要指标已经定下了,但考虑到他只能尽量去适配所有业务,有些业务有对某项值消耗的非常厉害,但主要指标不一定能统计到的,所以我们还要添加一些辅助指标,以完善我们的内存监控系统</p>
<ul>
<li><code>SUnreclaim</code> ,就像我们上面提到的,这个指标一般机器是不会出现的,只有涉及到tcp等问题才会导致该常数的值异常,这个异常用我们的主要指标是很难分析到的.</li>
<li><code>buffer</code>, <code>cached</code>,正常情况下的业务该值是不会有异常的,但是在涉及到一些io读写比较多的情景时,机器上面很多内存会被buffer,cached占用.<h2 id="3-附录"><a href="#3-附录" class="headerlink" title="3. 附录"></a>3. 附录</h2><h3 id="3-1-正常机器数据"><a href="#3-1-正常机器数据" class="headerlink" title="3.1. 正常机器数据"></a>3.1. 正常机器数据</h3>该章节主要用于展示数据,对比与原来的数据差别<h3 id="3-2-free"><a href="#3-2-free" class="headerlink" title="3.2. free"></a>3.2. free</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache">              <span class="hljs-attribute">total</span>        used        free      shared  buff/cache   available<br><span class="hljs-attribute">Mem</span>:          <span class="hljs-number">2</span>.<span class="hljs-number">0</span>Gi       <span class="hljs-number">193</span>Mi       <span class="hljs-number">921</span>Mi        <span class="hljs-number">20</span>Mi       <span class="hljs-number">882</span>Mi       <span class="hljs-number">1</span>.<span class="hljs-number">6</span>Gi<br><span class="hljs-attribute">Swap</span>:            <span class="hljs-number">0</span>B          <span class="hljs-number">0</span>B          <span class="hljs-number">0</span>B<br></code></pre></td></tr></table></figure>
<h3 id="3-3-cat-proc-meminfo"><a href="#3-3-cat-proc-meminfo" class="headerlink" title="3.3. cat /proc/meminfo"></a>3.3. cat /proc/meminfo</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">MemTotal:        2045852 kB</span><br><span class="hljs-section">MemFree:          937856 kB</span><br><span class="hljs-section">MemAvailable:    1658140 kB</span><br><span class="hljs-section">Buffers:           56928 kB</span><br><span class="hljs-section">Cached:           779772 kB</span><br><span class="hljs-section">SwapCached:            0 kB</span><br><span class="hljs-section">Active:           356800 kB</span><br><span class="hljs-section">Inactive:         604076 kB</span><br><span class="hljs-section">Active(anon):     121720 kB</span><br><span class="hljs-section">Inactive(anon):    20808 kB</span><br><span class="hljs-section">Active(file):     235080 kB</span><br><span class="hljs-section">Inactive(file):   583268 kB</span><br><span class="hljs-section">Unevictable:           0 kB</span><br><span class="hljs-section">Mlocked:               0 kB</span><br><span class="hljs-section">SwapTotal:             0 kB</span><br><span class="hljs-section">SwapFree:              0 kB</span><br><span class="hljs-section">Dirty:                28 kB</span><br><span class="hljs-section">Writeback:             0 kB</span><br><span class="hljs-section">AnonPages:        121908 kB</span><br><span class="hljs-section">Mapped:            36768 kB</span><br><span class="hljs-section">Shmem:             20972 kB</span><br><span class="hljs-section">Slab:             104908 kB</span><br><span class="hljs-section">SReclaimable:      67096 kB</span><br><span class="hljs-section">SUnreclaim:        37812 kB</span><br><span class="hljs-section">KernelStack:        1612 kB</span><br><span class="hljs-section">PageTables:         2088 kB</span><br><span class="hljs-section">NFS_Unstable:          0 kB</span><br><span class="hljs-section">Bounce:                0 kB</span><br><span class="hljs-section">WritebackTmp:          0 kB</span><br><span class="hljs-section">CommitLimit:     1022924 kB</span><br><span class="hljs-section">Committed_AS:     398732 kB</span><br><span class="hljs-section">VmallocTotal:   34359738367 kB</span><br><span class="hljs-section">VmallocUsed:           0 kB</span><br><span class="hljs-section">VmallocChunk:          0 kB</span><br><span class="hljs-section">Percpu:              356 kB</span><br><span class="hljs-section">AnonHugePages:     51200 kB</span><br><span class="hljs-section">ShmemHugePages:        0 kB</span><br><span class="hljs-section">ShmemPmdMapped:        0 kB</span><br><span class="hljs-section">HugePages_Total:       0</span><br><span class="hljs-section">HugePages_Free:        0</span><br><span class="hljs-section">HugePages_Rsvd:        0</span><br><span class="hljs-section">HugePages_Surp:        0</span><br><span class="hljs-section">Hugepagesize:       2048 kB</span><br><span class="hljs-section">Hugetlb:               0 kB</span><br><span class="hljs-section">DirectMap4k:      163812 kB</span><br><span class="hljs-section">DirectMap2M:     1933312 kB</span><br><span class="hljs-section">DirectMap1G:           0 kB</span><br></code></pre></td></tr></table></figure>
<h3 id="3-4-slabtop"><a href="#3-4-slabtop" class="headerlink" title="3.4. slabtop"></a>3.4. slabtop</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">OBJS</span> ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME                   <br><span class="hljs-attribute">183456</span> <span class="hljs-number">179948</span>  <span class="hljs-number">98</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">10</span>K   <span class="hljs-number">4704</span>       <span class="hljs-number">39</span>     <span class="hljs-number">18816</span>K buffer_head<br> <span class="hljs-attribute">57036</span>  <span class="hljs-number">55070</span>  <span class="hljs-number">96</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">19</span>K   <span class="hljs-number">2716</span>       <span class="hljs-number">21</span>     <span class="hljs-number">10864</span>K dentry<br> <span class="hljs-attribute">51639</span>  <span class="hljs-number">51639</span> <span class="hljs-number">100</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">19</span>K   <span class="hljs-number">2459</span>       <span class="hljs-number">21</span>      <span class="hljs-number">9836</span>K kmalloc-<span class="hljs-number">192</span><br> <span class="hljs-attribute">24684</span>  <span class="hljs-number">24684</span> <span class="hljs-number">100</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">04</span>K    <span class="hljs-number">242</span>      <span class="hljs-number">102</span>       <span class="hljs-number">968</span>K ext<span class="hljs-number">4</span>_extent_status<br> <span class="hljs-attribute">17280</span>  <span class="hljs-number">16530</span>  <span class="hljs-number">95</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">03</span>K    <span class="hljs-number">135</span>      <span class="hljs-number">128</span>       <span class="hljs-number">540</span>K kmalloc-<span class="hljs-number">32</span><br> <span class="hljs-attribute">17055</span>  <span class="hljs-number">16817</span>  <span class="hljs-number">98</span>%    <span class="hljs-number">1</span>.<span class="hljs-number">05</span>K   <span class="hljs-number">1137</span>       <span class="hljs-number">15</span>     <span class="hljs-number">18192</span>K ext<span class="hljs-number">4</span>_inode_cache<br> <span class="hljs-attribute">15420</span>  <span class="hljs-number">15420</span> <span class="hljs-number">100</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">13</span>K    <span class="hljs-number">514</span>       <span class="hljs-number">30</span>      <span class="hljs-number">2056</span>K kernfs_node_cache<br> <span class="hljs-attribute">11520</span>  <span class="hljs-number">10774</span>  <span class="hljs-number">93</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">06</span>K    <span class="hljs-number">180</span>       <span class="hljs-number">64</span>       <span class="hljs-number">720</span>K anon_vma_chain<br> <span class="hljs-attribute">11479</span>  <span class="hljs-number">11416</span>  <span class="hljs-number">99</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">59</span>K    <span class="hljs-number">883</span>       <span class="hljs-number">13</span>      <span class="hljs-number">7064</span>K inode_cache<br> <span class="hljs-attribute">11136</span>  <span class="hljs-number">11136</span> <span class="hljs-number">100</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">06</span>K    <span class="hljs-number">174</span>       <span class="hljs-number">64</span>       <span class="hljs-number">696</span>K tcp_bind_bucket<br>  <span class="hljs-attribute">9024</span>   <span class="hljs-number">7905</span>  <span class="hljs-number">87</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">06</span>K    <span class="hljs-number">141</span>       <span class="hljs-number">64</span>       <span class="hljs-number">564</span>K kmalloc-<span class="hljs-number">64</span><br>  <span class="hljs-attribute">8960</span>   <span class="hljs-number">8960</span> <span class="hljs-number">100</span>%    <span class="hljs-number">0</span>.<span class="hljs-number">02</span>K     <span class="hljs-number">35</span>      <span class="hljs-number">256</span>       <span class="hljs-number">140</span>K kmalloc-<span class="hljs-number">16</span><br></code></pre></td></tr></table></figure>


</li>
</ul>
      </section>
      <section class="extra">
        
          <ul class="copyright">
  
    <li><strong>本文作者：</strong>So1n</li>
    <li><strong>本文链接：</strong><a href="http://so1n.me/2020/05/28/%E5%86%85%E5%AD%98%E7%BB%9F%E8%AE%A1/index.html" title="http:&#x2F;&#x2F;so1n.me&#x2F;2020&#x2F;05&#x2F;28&#x2F;%E5%86%85%E5%AD%98%E7%BB%9F%E8%AE%A1&#x2F;index.html">http:&#x2F;&#x2F;so1n.me&#x2F;2020&#x2F;05&#x2F;28&#x2F;%E5%86%85%E5%AD%98%E7%BB%9F%E8%AE%A1&#x2F;index.html</a></li>
    <li><strong>版权声明：</strong>本博客所有文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" title="BY-NC-SA" target="_blank" rel="noopener">BY-NC-SA</a> 许可协议，转载请注明出处！</li>
  
</ul>
        
        
          <section class="donate">
  <div id="qrcode-donate">
    <img   class="lazyload" data-original="https://github.com/so1n/so1n_blog_photo/blob/master/blog_photo/4d2ebf32586d8799ee2e75333d6f5d2.jpg?raw=true" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" >
  </div>
  <div class="icon">
    <a href="javascript:;" id="alipay"><i class="iconfont iconalipay"></i></a>
    <a href="javascript:;" id="wechat"><i class="iconfont iconwechat-fill"></i></a>
  </div>
</section>
        
        
  <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li></ul> 

        
  <nav class="nav">
    <a href="/2020/06/03/Python%E7%9A%84TypeHints/"><i class="iconfont iconleft"></i>Python的TypeHints</a>
    <a href="/2020/04/10/%E8%AE%B0%E4%B8%80%E6%AC%A1ElasticSearch%E5%86%B7%E7%83%AD%E5%88%86%E7%A6%BB%E7%B4%A2%E5%BC%95%E6%97%A0%E6%B3%95%E6%AD%A3%E7%A1%AE%E5%88%86%E9%85%8D%E7%9A%84%E9%97%AE%E9%A2%98/">记一次ElasticSearch冷热分离索引无法正确分配的问题<i class="iconfont iconright"></i></a>
  </nav>

      </section>
      
        <section class="comments">
  
    <div class="btn" id="comments-btn">查看评论</div>
  
  
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<div id="gitalk" class="gitalk"></div>
<script defer src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
  window.onload = function () {
    var gitalk = new Gitalk({
      clientID: '59f804e526b05c378470',
      clientSecret: '36679ff697cec424936a0f7c4bcd6d2988dac28e',
      id: window.location.pathname,
      repo: 'so1n.github.io',
      owner: 'so1n',
      admin: 'so1n'
    });
    if ( true ) {
      $("#comments-btn").on("click", function () {
        $(this).hide();
        gitalk.render('gitalk');
      });
    } else {
      gitalk.render('gitalk');
    }
  }
</script>

</section>
      
    </section>
  </div>
</article></div>
      <div class="col-xl-3">
        
          
  <aside class="toc-wrap">
    <h3 class="toc-title">文章目录：</h3>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%AE%B0"><span class="toc-text">前记</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%B8%80%E6%AC%A1%E2%80%9D%E5%86%85%E5%AD%98%E6%8A%A5%E8%AD%A6%E5%BC%82%E5%B8%B8%E2%80%9D"><span class="toc-text">1.一次”内存报警异常”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E9%97%AE%E9%A2%98"><span class="toc-text">1.1.问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E6%8E%92%E6%9F%A5%E9%97%AE%E9%A2%98%E6%9C%BA%E5%99%A8"><span class="toc-text">1.2.排查问题机器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%A6%81%E7%9B%91%E6%8E%A7%E5%93%AA%E4%BA%9B%E5%86%85%E5%AD%98"><span class="toc-text">2.要监控哪些内存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%99%84%E5%BD%95"><span class="toc-text">3. 附录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%AD%A3%E5%B8%B8%E6%9C%BA%E5%99%A8%E6%95%B0%E6%8D%AE"><span class="toc-text">3.1. 正常机器数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-free"><span class="toc-text">3.2. free</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-cat-proc-meminfo"><span class="toc-text">3.3. cat &#x2F;proc&#x2F;meminfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-slabtop"><span class="toc-text">3.4. slabtop</span></a></li></ol></li></ol>
  </aside>

        
      </div>
    </div>
  </div>
</main>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>


<footer class="footer">
  <div class="footer-social"><a 
        href="https://github.com/so1n "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#9f7be1'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  icongithub-fill "></i>
      </a></div>
  
    <div class="footer-copyright"><p>Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme - <a target="_blank" href="https://github.com/izhaoo/hexo-theme-zhaoo">zhaoo</a></p></div>
  
  <div class="footer-copyright">
    总访问量<span id="busuanzi_value_site_pv"></span>次
    访客数<span id="busuanzi_value_site_uv"></span>人次
  </div>

</footer>

  
      <div class="fab fab-plus">
    <i class="iconfont iconplus"></i>
  </div>
  
  
  <div class="fab fab-up">
    <i class="iconfont iconcaret-up"></i>
  </div>
  
  
    <div class="scrollbar j-scrollbar">
  <div class="scrollbar-current j-scrollbar-current"></div>
</div>
  
  
    
<script src="/js/color-mode.js"></script>

  
</body>

<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>



  
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>




  
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>






  
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>




<script src="/js/utils.js"></script>
<script src="/js/script.js"></script>







  <script>
    (function () {
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>













</html>